<div class="container mt-4">

  <!-- Cabeçalho -->
  <div class="row mb-4">
    <div class="col-12">
      <h2 class="text-center mb-4">
        <i class="bi bi-person-gear me-2"></i>{{ isEditMode ? 'Editar Usuário' : 'Cadastrar Usuário' }}
      </h2>
    </div>
  </div>

  <!-- Mensagens -->
  @if (mensagem) {
  <div class="alert alert-success alert-dismissible fade show">
    {{ mensagem }}
    <button type="button" class="btn-close" (click)="mensagem = ''"></button>
  </div>
  }

  @if (erro) {
  <div class="alert alert-danger alert-dismissible fade show">
    {{ erro }}
    <button type="button" class="btn-close" (click)="erro = ''"></button>
  </div>
  }

  <!-- Loading principal -->
  @if (isLoading && !isCapturingBiometry) {
  <div class="text-center my-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Carregando...</span>
    </div>
    <p class="mt-2">
      {{ isEditMode ? 'Carregando usuário...' : 'Salvando usuário...' }}
    </p>
  </div>
  }

  <!-- Loading para captura de biometria -->
  @if (isCapturingBiometry) {
  <div class="card mb-4">
    <div class="card-body text-center py-5">
      <div class="spinner-border text-warning mb-3" role="status">
        <span class="visually-hidden">Capturando biometria...</span>
      </div>
      <p class="text-warning mb-3">
        <i class="bi bi-fingerprint me-2"></i>
        Aguarde... Capturando biometria. Coloque o dedo no leitor.
      </p>

      <!-- Botão para cancelar a captura -->
      <button class="btn btn-outline-danger btn-sm"
              (click)="cancelarCapturaBiometria()">
        <i class="bi bi-x-circle me-1"></i> Cancelar Captura
      </button>

      <!-- Mensagem de erro durante a captura -->
      @if (biometryError) {
      <div class="alert alert-danger mt-3">
        <small>{{ biometryError }}</small>
      </div>
      }
    </div>
  </div>
  }

  <!-- Conteúdo principal -->
  @if (!isLoading) {
  <div class="card">
    <div class="card-header bg-light">
      <i class="bi bi-person-badge me-2"></i>Informações do Usuário
    </div>
    <div class="card-body">
      <form #usuarioForm="ngForm">
        <div class="row g-3">
          
          <!-- CPF -->
          <div class="col-md-6">
            <label for="cpf" class="form-label">CPF <span class="text-danger">*</span></label>
            <input id="cpf" type="text" class="form-control"
                  [(ngModel)]="usuario.cpf" name="cpf"
                  mask="000.000.000-00" required
                  [disabled]="isEditMode"
                  placeholder="000.000.000-00"
                  [class.is-invalid]="cpfInvalido">
            @if (cpfInvalido) {
            <div class="invalid-feedback">
              CPF inválido.
            </div>
            }
          </div>

          <!-- Data de Nascimento -->
          <div class="col-md-6">
            <label for="dataNascimento" class="form-label">Data de Nascimento <span class="text-danger">*</span></label>
            <input id="dataNascimento" type="date" class="form-control"
                  [(ngModel)]="usuario.dataNascimento" name="dataNascimento" required>
          </div>

          <!-- Nome -->
          <div class="col-md-6">
            <label for="nome" class="form-label">Nome Completo <span class="text-danger">*</span></label>
            <input id="nome" type="text" class="form-control"
                  [(ngModel)]="usuario.nome" name="nome" required
                  placeholder="Digite o nome completo">
          </div>

          <!-- Matrícula -->
          <div class="col-md-6">
            <label for="matricula" class="form-label">Matrícula <span class="text-danger">*</span></label>
            <input id="matricula" type="text" class="form-control"
                  [(ngModel)]="usuario.matricula" name="matricula" required
                  placeholder="Digite a matrícula">
          </div>

          <!-- Setor -->
          <div class="col-md-6">
            <label for="setor" class="form-label">Setor</label>
            <input id="setor" type="text" class="form-control"
                  [(ngModel)]="usuario.setor" name="setor"
                  placeholder="Opcional">
          </div>

          <!-- Biometria - Mantido como estava -->
          <div class="col-md-6">
            <label for="biometria" class="form-label">Biometria <span class="text-danger">*</span></label>
            <div class="input-group">
              <input id="biometria" type="text" class="form-control"
                    [(ngModel)]="usuario.template" name="biometria"
                    readonly placeholder="Hash da biometria">
              <button type="button" class="btn btn-primary"
                      (click)="obterBiometria()" title="Obter Biometria"
                      [disabled]="isLoading">
                <i class="bi bi-fingerprint me-1"></i> Capturar
              </button>
            </div>
            <small class="text-muted">Clique no botão para capturar a biometria</small>
            
            <!-- Status da biometria -->
            @if (usuario.template && !isCapturingBiometry) {
            <div class="mt-2">
              <span class="badge bg-success">
                <i class="bi bi-check-circle me-1"></i>Biometria cadastrada
              </span>
            </div>
            }
          </div>

          <!-- Botões -->
          <div class="col-12">
            <div class="d-flex gap-2 justify-content-end pt-3">
              <!-- Modo Criação -->
              @if (!isEditMode) {
              <button type="button" class="btn btn-outline-secondary"
                      (click)="cancelar()">
                <i class="bi bi-x-circle me-1"></i> Cancelar
              </button>
              <button type="button" class="btn btn-success"
                      (click)="salvarUsuario()"
                      [disabled]="!usuarioForm.valid || !usuario.template || isLoading">
                <i class="bi bi-person-plus me-1"></i> Cadastrar Usuário
              </button>
              }

              <!-- Modo Edição -->
              @if (isEditMode) {
              <button type="button" class="btn btn-outline-secondary"
                      (click)="cancelar()">
                <i class="bi bi-arrow-left me-1"></i> Voltar
              </button>
              <button type="button" class="btn btn-outline-info"
                      (click)="obterBiometria()" 
                      [disabled]="isLoading">
                <i class="bi bi-fingerprint me-1"></i> Atualizar Biometria
              </button>
              <button type="button" class="btn btn-outline-danger"
                      (click)="remover()" 
                      [disabled]="isLoading">
                <i class="bi bi-trash me-1"></i> Remover
              </button>
              <button type="button" class="btn btn-primary"
                      (click)="salvarUsuario()"
                      [disabled]="!usuarioForm.valid || isLoading">
                <i class="bi bi-check-circle me-1"></i> Salvar
              </button>
              }
            </div>
          </div>

          <!-- Campos obrigatórios -->
          <div class="col-12">
            <small class="text-muted">* Campos obrigatórios</small>
          </div>
        </div>
      </form>
    </div>
  </div>
  }
</div>